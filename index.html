<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>subway</title>
    <style>
        body {
            margin: auto;
        }

        .my-canvas {
            position: absolute;
            border: 1px solid #d3d3d3;
            left: 50%;
            background: white;
            margin-left: -750px;
        }
    </style>
</head>
<body>
<canvas id="myCanvas" width="1600" height="1500" class="my-canvas"></canvas>
</body>
</html>
<script src="js/station.js"></script>
<script src="js/name.js"></script>
<script>

    window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

    var colorList = {
        1001: {
            r: 228,
            g: 120,
            b: 120,
            a: 1
        },
        1002: {
            r: 85,
            g: 145,
            b: 206,
            a: 1
        },
        1004: {
            r: 23,
            g: 190,
            b: 176,
            a: 1
        },
        1005: {
            r: 207,
            g: 112,
            b: 179,
            a: 1
        },
        1006: {
            r: 226,
            g: 161,
            b: 22,
            a: 1
        },
        1007: {
            r: 179,
            g: 143,
            b: 101,
            a: 1
        },
        1008: {
            r: 71,
            g: 184,
            b: 82,
            a: 1
        },
        1009: {
            r: 136,
            g: 173,
            b: 46,
            a: 1
        },
        1010: {
            r: 59,
            g: 174,
            b: 202,
            a: 1
        },
        1013: {
            r: 191,
            g: 126,
            b: 22,
            a: 1
        },
        1014: {
            r: 185,
            g: 128,
            b: 128,
            a: 1
        },
        1015: {
            r: 138,
            g: 112,
            b: 185,
            a: 1
        },
        1016: {
            r: 90,
            g: 142,
            b: 119,
            a: 1
        },
        1051: {
            r: 228,
            g: 120,
            b: 120,
            a: 1
        },
        1052: {
            r: 177,
            g: 134,
            b: 164,
            a: 1
        },
        1053: {
            r: 219,
            g: 130,
            b: 64,
            a: 1
        },
        1054: {
            r: 177,
            g: 153,
            b: 187,
            a: 1
        },
        1055: {
            r: 222,
            g: 89,
            b: 130,
            a: 1
        }
    };
    var position = 700;
    var rate = 0.75;

    var fps = 30;
    var now;
    var then = Date.now();
    var interval = 1000 / fps;
    var delta;


    var RENDERER = {
        init: function () {
            this.setParameters();
            requestAnimationFrame(this.render);
        },
        setParameters: function () {
            this.cxt = document.getElementById("myCanvas").getContext("2d");
            this.cxt.imageSmoothingEnabled = true;
        },

        render: function () {
            requestAnimationFrame(RENDERER.render);
            now = Date.now();
            delta = now - then;
            if (delta > interval) {
                then = now - (delta % interval);
                RENDERER.cxt.clearRect(0, 0, 1600, 1500);
                RENDERER.drawMap();
            }
        },
        drawMap: function () {
            for (var i = 0; i < staPos.length; i++) {
                //算当前点坐标
                var centerX = parseInt((parseFloat(staPos[i].cx) - parseFloat(centerPoint.cx)  ) * rate) + position;
                var centerY = parseInt((parseFloat(staPos[i].cy) - parseFloat(centerPoint.cy) ) * rate) + position;
                //获取id
                var id = parseInt(staPos[i].id);
                //获取所在线路
                var lineIndex = staPos[i].id.substr(0, 4);
                //如果不是最后一个点  画线
                if (i != staPos.length - 1) {
                    //算先一个点的坐标
                    var nextCenterX = parseInt((parseFloat(staPos[i + 1].cx) - parseFloat(centerPoint.cx)  ) * rate) + position;
                    var nextCenterY = parseInt((parseFloat(staPos[i + 1].cy) - parseFloat(centerPoint.cy) ) * rate) + position;
                    var nextId = parseInt(staPos[i + 1].id);
                    //如果id相差1 说明是同线路相邻站点 画线
                    if ((id + 1 == nextId) || (id - 1 == nextId)) {
                        RENDERER.drawLine(RENDERER.cxt, centerX, centerY, nextCenterX, nextCenterY, 5, RENDERER.getLineColor(lineIndex), staPos[i].hasOwnProperty('bezier') ? staPos[i].bezier : undefined)
                    }
                    // 是否存在下一站 只有在环形中有此判断 用于闭合环形
                    if (staPos[i].hasOwnProperty('nextStation')) {
                        nextCenterX = parseInt((parseFloat(staPos[i]['nextStation'].cx) - parseFloat(centerPoint.cx)  ) * rate) + position;
                        nextCenterY = parseInt((parseFloat(staPos[i]['nextStation'].cy) - parseFloat(centerPoint.cy) ) * rate) + position;
                        RENDERER.drawLine(RENDERER.cxt, centerX, centerY, nextCenterX, nextCenterY, 5, RENDERER.getLineColor(lineIndex), staPos[i].hasOwnProperty('bezier') ? staPos[i].bezier : undefined);
                        RENDERER.drawPoint(RENDERER.cxt, nextCenterX, nextCenterY, 3, 1, 'white', RENDERER.getLineColor(lineIndex))
                    }
                }
                // 画点 换乘站
                if (staPos[i].transfer == 'true') {
                    RENDERER.drawPoint(RENDERER.cxt, centerX, centerY, 5, 2, 'white', 'rgba(255,0,0,' + colorList[lineIndex].a + ')')
                } else {//画点 非换乘站
                    RENDERER.drawPoint(RENDERER.cxt, centerX, centerY, 3, 1, 'white', RENDERER.getLineColor(lineIndex))
                }
                var nameX = parseInt((parseFloat(staPos[i].namePoint.x) - parseFloat(centerPoint.cx) - 10) * rate) + position;
                var nameY = parseInt((parseFloat(staPos[i].namePoint.y) - parseFloat(centerPoint.cy)) * rate) + position;
                RENDERER.drawText(RENDERER.cxt, nameX, nameY, staPos[i].name, 'rgba(0,0,0,' + colorList[lineIndex].a + ')');
            }
        },
        drawPoint: function (context, x, y, r, lineWidth, fillColor, strokeColor) {
            context.beginPath();
            context.lineWidth = lineWidth;//设置线宽
            context.arc(x, y, r, 0, 360, false);
            context.fillStyle = fillColor;//填充颜色
            context.strokeStyle = strokeColor; //线颜色
            context.fill(); //画实心圆
            context.stroke();//画空心圆
            context.closePath();
        },
        drawLine: function (context, x, y, nx, ny, lineWidth, color, bezier) {
            if (bezier) {
                context.strokeStyle = color;//线条颜色：绿色
                context.lineWidth = lineWidth;//设置线宽
                context.beginPath();
                context.moveTo(x, y);
                var bx = parseInt((parseFloat(bezier.x) - parseFloat(centerPoint.cx)  ) * rate) + position;
                var by = parseInt((parseFloat(bezier.y) - parseFloat(centerPoint.cy) ) * rate) + position;
                if (bezier.hasOwnProperty('x2')) {
                    var bx2 = parseInt((parseFloat(bezier.x2) - parseFloat(centerPoint.cx)  ) * rate) + position;
                    var by2 = parseInt((parseFloat(bezier.y2) - parseFloat(centerPoint.cy) ) * rate) + position;
                    context.bezierCurveTo(bx, by, bx2, by2, nx, ny);
                } else {
                    context.quadraticCurveTo(bx, by, nx, ny);
                }
                context.stroke();//画线框
                context.closePath();//可以把这句注释掉再运行比较下不同
            } else {
                context.strokeStyle = color;//线条颜色：绿色
                context.lineWidth = lineWidth;//设置线宽
                context.beginPath();
                context.moveTo(x, y);
                context.lineTo(nx, ny);
                context.stroke();//画线框
                context.fill();//填充颜色
                context.closePath();//可以把这句注释掉再运行比较下不同
            }

        },
        drawText: function (context, x, y, text, color) {
            context.fillStyle = color;//线条颜色：绿色
            context.font = "6px Microsoft YaHei";
            context.fillText(text, x, y);
        },
        getLineColor: function (index) {
            return 'rgba(' + colorList[index].r + ',' + colorList[index].g + ',' + colorList[index].b + ',' + colorList[index].a + ')';

        }
    };
    RENDERER.init();
    setTimeout(function () {
        for (var item in colorList) {
            colorList[item].a = 0.1;
        }
        colorList[1001].a = 1;
        colorList[1002].a = 1
    }, 2000)

</script>